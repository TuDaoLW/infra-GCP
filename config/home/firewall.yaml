---
firewall_rules:
  # Management rules
  # - name: allow-ssh-from-admin-ips # use IAP
  #   network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
  #   direction: INGRESS
  #   priority: 100
  #   action: ALLOW
  #   source_ranges:
  #     - "YOUR_ADMIN_IP_RANGE_1"
  #     - "YOUR_ADMIN_IP_RANGE_2"
  #   target_tags: ["ssh-allowed"] # Applies to VMs tagged 'ssh-allowed'
  #   protocols:
  #     - protocol: tcp
  #       ports: ["22"]
  #   description: "Allows SSH from specified trusted admin IP ranges to VMs with 'ssh-allowed' tag."
  
  allow-master-to-nodes:
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 100  # Higher than denies
    action: ALLOW
    source_ranges: ["172.16.0.32/28"]  # Your master_ipv4_cidr_block
    target_tags: ["gke-node"]  # Or whatever tag your GKE subnet uses for nodes
    protocols:
      - protocol: tcp
        ports: ["443", "10250"]
    description: "Allows GKE control plane to communicate with nodes (required for private clusters)."

  allow-iap-ssh: # Access to VMs with no public IP via IAP, like AWS SSM
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 110
    action: ALLOW
    source_ranges: ["35.235.240.0/20"] # Google's IP range for IAP TCP Forwarding
    target_tags: ["iap-ssh"]
    protocols:
      - protocol: tcp
        ports: ["22"]
    description: "Allows SSH access to VMs tagged 'iap-ssh' via Google Cloud IAP (Identity-Aware Proxy)."

  # Application-Specific Ingress Rules
  allow-gke-to-databases:
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 200
    action: ALLOW
    # Production Best Practice: Use specific subnets for source/target if possible,
    # or leverage service accounts if only specific service accounts should initiate traffic.
    # If source_service_accounts is desired, use it like this:
    # source_service_accounts: ["gke-node-sa@adroit-nimbus-481707-i0.iam.gserviceaccount.com"]
    source_ranges:
      - "10.0.2.0/23" # GKE Node IPs
      - "10.1.0.0/20" # GKE Pod IPs
      - "10.2.0.0/20" # GKE Services IPs
    target_ranges:
      - "10.0.1.0/24" # Database subnet CIDR
    protocols:
      - protocol: tcp
        ports: ["5432", "3306", "1433", "6379"] # PostgreSQL, MySQL, SQL Server, Redis
    description: "Allows traffic from GKE nodes/pods to the database subnet on specified database ports."

  # internal VPC communication
  allow-internal-all-subnets:
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 300
    action: ALLOW
    source_ranges:
      - "10.0.0.0/8"
    target_ranges:
      - "10.0.0.0/8"
    protocols:
      - protocol: tcp
        ports: ["0-65535"]
      - protocol: udp
        ports: ["0-65535"]
      - protocol: icmp
    description: "Allows all TCP/UDP/ICMP communication between internal subnets within the 'sample-vpc'."

  # Load Balancer Health Check Rules (Required for Load Balancers)
  allow-lb-health-checks: # Allows Google Cloud Load Balancer health probes
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 500
    action: ALLOW
    source_ranges:
      - "35.191.0.0/16" # Ranges for external HTTP(S), SSL Proxy, TCP Proxy LB health checks
      - "130.211.0.0/22" # Ranges for all Load Balancer health checks
      - "209.85.152.0/22" # Additional range for Internal TCP/UDP Load Balancer health checks
      - "209.85.204.0/22" # Additional range for Internal TCP/UDP Load Balancer health checks
      # These ranges are published by Google and should be kept up to date.
    # Target can be specific tags (e.g., 'gke-node', 'application-backend')
    # or specific service accounts if more granular targeting is needed.
    # For GKE, target_tags on the node pool is often easiest.
    target_tags: ["gke-node", "application-backend", "management-server"]
    # If target_service_accounts is preferred:
    # target_service_accounts: ["gke-node-sa@adroit-nimbus-481707-i0.iam.gserviceaccount.com"]
    protocols:
      - protocol: tcp
        ports: ["80", "443", "8080", "8443", "10250"]
    description: "Allows Google Cloud Load Balancer health check probes to target backends."

  # ------------------------------------------------------------------------
  # Egress Rules (Outbound Traffic)
  # ------------------------------------------------------------------------

  allow-egress-to-internet: # Outbound connections to the internet
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: EGRESS
    priority: 1100 # Default priority for general outbound rules
    action: ALLOW
    destination_ranges: ["0.0.0.0/0"] # Allows outbound to all external IPs
    # Target specific instances/tags that should have internet access.
    # VMs without public IPs will rely on Cloud NAT for internet egress if configured.
    # This rule primarily applies to VMs with public IPs or those that directly need egress.
    target_tags: ["outbound-internet", "management-server", "gke-node"] # Instances needing internet access
    protocols:
      - protocol: tcp
        ports: ["80", "443", "53"] # HTTP, HTTPS, DNS
      - protocol: udp
        ports: ["53"] # DNS
      - protocol: icmp # Ping and other ICMP uses
    description: "Allows specified instances to make outbound connections to the internet on common ports."

  # ------------------------------------------------------------------------
  # Catch-All Deny Rules (Critical for Security)
  # These ensure that anything not explicitly allowed is denied.
  # ------------------------------------------------------------------------

  deny-all-other-ingress: # Explicitly deny all other inbound traffic
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 65534 # High number to ensure it's evaluated last for ingress
    action: DENY
    source_ranges: ["0.0.0.0/0"] # From anywhere
    destination_ranges: ["0.0.0.0/0"] # To anywhere (within the network)
    protocols:
      - protocol: all # Deny all protocols
    description: "Explicitly denies all inbound traffic not explicitly allowed by higher priority rules. Critical for 'deny by default' security."

  deny-all-other-egress: # Explicitly deny all other outbound traffic
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: EGRESS
    priority: 65534 # Same high number to ensure it's evaluated last for egress
    action: DENY
    source_ranges: ["0.0.0.0/0"] # From anywhere (within the network)
    destination_ranges: ["0.0.0.0/0"] # To anywhere
    protocols:
      - protocol: all # Deny all protocols
    description: "Explicitly denies all outbound traffic not explicitly allowed by higher priority rules. Critical for 'deny by default' security."

  # ------------------------------------------------------------------------
  # Essential GCP Default-like Rules (often implicitly created or best to define)
  # ------------------------------------------------------------------------

  allow-internal-icmp: # Allow ICMP for internal network diagnostics
    network: "projects/adroit-nimbus-481707-i0/global/networks/sample-vpc"
    direction: INGRESS
    priority: 400
    action: ALLOW
    source_ranges: ["10.0.0.0/8"]
    target_ranges: ["10.0.0.0/8"]
    protocols:
      - protocol: icmp
    description: "Allows internal ICMP traffic for basic network diagnostics (ping)."
